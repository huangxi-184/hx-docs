<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NCM文件处理器</title>
    <style>
      :root {
        --primary-color: #4a6bff;
        --success-color: #4caf50;
        --error-color: #f44336;
        --text-color: #333;
        --bg-color: #f5f7fa;
        --border-color: #e0e0e0;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }

      #pickFolder {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      #pickFolder:hover {
        background-color: #3a5bef;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      #fileList {
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      #fileList h3 {
        margin-top: 0;
        color: var(--primary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
      }

      #fileList ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      #fileList li {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
      }

      #fileList li:last-child {
        border-bottom: none;
      }

      #fileList li:before {
        content: '•';
        color: var(--primary-color);
        font-weight: bold;
        display: inline-block;
        width: 1em;
        margin-right: 10px;
      }

      #fileList li[style='color: red;'] {
        color: var(--error-color) !important;
      }

      #fileList li[style='color: red;']:before {
        content: '✗';
      }

      #status {
        margin: 20px 0;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        font-weight: 500;
      }

      .success-icon {
        color: var(--success-color);
        margin-right: 8px;
      }

      .progress-container {
        margin-top: 15px;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: var(--primary-color);
        width: 0%;
        transition: width 0.3s ease;
      }

      @media (max-width: 600px) {
        body {
          padding: 15px;
        }

        #pickFolder {
          width: 100%;
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <h1>NCM文件处理器(仅自用,解密算法由开源大佬提供)</h1>
    <button id="pickFolder">选择源文件夹</button>
    <div id="status">准备就绪，请选择包含NCM文件的文件夹</div>
    <div id="fileList"></div>

    <script src="./decrypt.js"></script>
    <script>
      document.getElementById('pickFolder').addEventListener('click', async () => {
        try {
          // 第一步：选择包含NCM文件的源目录
          const dirHandle = await window.showDirectoryPicker();
          const fileList = document.getElementById('fileList');
          const statusDiv = document.getElementById('status');

          fileList.innerHTML = '<h3>NCM文件列表：</h3><ul></ul>';
          statusDiv.innerHTML = `
                    <span class="success-icon">✓</span> 正在扫描文件夹...
                    <div class="progress-container"><div class="progress-bar" id="scanProgress"></div></div>
                `;

          // 收集所有.ncm文件
          const ncmFiles = [];
          let totalFiles = 0;

          // 递归遍历目录
          async function processDirectory(handle, path = '') {
            for await (const entry of handle.values()) {
              if (entry.kind === 'file' && entry.name.toLowerCase().endsWith('.ncm')) {
                totalFiles++;
                document.getElementById('scanProgress').style.width = `${(ncmFiles.length / totalFiles) * 100}%`;
                ncmFiles.push({ handle: entry, path: path ? `${path}/${entry.name}` : entry.name });
                const li = document.createElement('li');
                li.innerHTML = `<span>${path ? `${path}/` : ''}${entry.name}</span>`;
                fileList.querySelector('ul').appendChild(li);
              } else if (entry.kind === 'directory') {
                await processDirectory(entry, path ? `${path}/${entry.name}` : entry.name);
              }
            }
          }

          await processDirectory(dirHandle);
          statusDiv.innerHTML = `<span class="success-icon">✓</span> 找到 ${ncmFiles.length} 个NCM文件，开始解码...`;

          // 第二步：让用户选择保存MP3的目标目录
          statusDiv.innerHTML = `<span class="success-icon">✓</span> 请选择保存MP3的文件夹...`;
          const saveDirHandle = await window.showDirectoryPicker();

          // 添加进度条
          statusDiv.innerHTML += `<div class="progress-container"><div class="progress-bar" id="convertProgress"></div></div>`;
          const progressBar = document.getElementById('convertProgress');

          // 批量解码并保存MP3文件
          for (let i = 0; i < ncmFiles.length; i++) {
            const { handle, path } = ncmFiles[i];
            try {
              statusDiv.innerHTML = `
                            <span class="success-icon">✓</span> 正在处理: ${path} (${i + 1}/${ncmFiles.length})
                            <div class="progress-container"><div class="progress-bar" style="width: ${
                              (i / ncmFiles.length) * 100
                            }%"></div></div>
                        `;

              const ncmFile = await handle.getFile();
              const mp3Blob = await decrypt.Decrypt(ncmFile);
              const mp3Filename = handle.name.replace(/\.ncm$/i, '.mp3');
              const mp3FileHandle = await saveDirHandle.getFileHandle(mp3Filename, { create: true });
              const writable = await mp3FileHandle.createWritable();
              await writable.write(mp3Blob.blob);
              await writable.close();

              // 更新文件列表项
              const li = fileList.querySelector(`ul li:nth-child(${i + 1})`);
              li.innerHTML = `<span class="success-icon">✓</span> ${path} → <strong>${mp3Filename}</strong>`;
              li.style.color = 'var(--success-color)';
            } catch (err) {
              console.error(`文件处理失败: ${path}`, err);
              const li = fileList.querySelector(`ul li:nth-child(${i + 1})`);
              li.innerHTML = `<span class="error-icon">✗</span> ${path} 处理失败: ${err.message}`;
              li.style.color = 'var(--error-color)';
            }
          }

          statusDiv.innerHTML = `<span class="success-icon">✓</span> 已完成 ${ncmFiles.length} 个NCM文件的解码和保存`;
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('操作失败:', err);
            document.getElementById('status').innerHTML = `
                        <span style="color: var(--error-color)">✗</span> 错误: ${err.message}
                    `;
          }
        }
      });
    </script>
  </body>
</html>
